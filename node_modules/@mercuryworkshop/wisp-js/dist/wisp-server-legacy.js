var wisp_server;(()=>{var t={706:function(t){!function(e){"use strict";const r="(0?\\d+|0x[a-f0-9]+)",s={fourOctet:new RegExp(`^${r}\\.${r}\\.${r}\\.${r}$`,"i"),threeOctet:new RegExp(`^${r}\\.${r}\\.${r}$`,"i"),twoOctet:new RegExp(`^${r}\\.${r}$`,"i"),longValue:new RegExp(`^${r}$`,"i")},n=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${r}\\.${r}\\.${r}\\.${r}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${r}\\.${r}\\.${r}\\.${r}(${o})?$`,"i")};function l(t,e){if(t.indexOf("::")!==t.lastIndexOf("::"))return null;let r,s,n=0,i=-1,o=(t.match(c.zoneIndex)||[])[0];for(o&&(o=o.substring(1),t=t.replace(/%.+$/,""));(i=t.indexOf(":",i+1))>=0;)n++;if("::"===t.substr(0,2)&&n--,"::"===t.substr(-2,2)&&n--,n>e)return null;for(s=e-n,r=":";s--;)r+="0:";return":"===(t=t.replace("::",r))[0]&&(t=t.slice(1)),":"===t[t.length-1]&&(t=t.slice(0,-1)),{parts:e=function(){const e=t.split(":"),r=[];for(let t=0;t<e.length;t++)r.push(parseInt(e[t],16));return r}(),zoneId:o}}function u(t,e,r,s){if(t.length!==e.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let n,i=0;for(;s>0;){if(n=r-s,n<0&&(n=0),t[i]>>n!==e[i]>>n)return!1;s-=r,i+=1}return!0}function h(t){if(i.test(t))return parseInt(t,16);if("0"===t[0]&&!isNaN(parseInt(t[1],10))){if(n.test(t))return parseInt(t,8);throw new Error(`ipaddr: cannot parse ${t} as octal`)}return parseInt(t,10)}function p(t,e){for(;t.length<e;)t=`0${t}`;return t}const d={};d.IPv4=function(){function t(t){if(4!==t.length)throw new Error("ipaddr: ipv4 octet count should be 4");let e,r;for(e=0;e<t.length;e++)if(r=t[e],!(0<=r&&r<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=t}return t.prototype.SpecialRanges={unspecified:[[new t([0,0,0,0]),8]],broadcast:[[new t([255,255,255,255]),32]],multicast:[[new t([224,0,0,0]),4]],linkLocal:[[new t([169,254,0,0]),16]],loopback:[[new t([127,0,0,0]),8]],carrierGradeNat:[[new t([100,64,0,0]),10]],private:[[new t([10,0,0,0]),8],[new t([172,16,0,0]),12],[new t([192,168,0,0]),16]],reserved:[[new t([192,0,0,0]),24],[new t([192,0,2,0]),24],[new t([192,88,99,0]),24],[new t([198,18,0,0]),15],[new t([198,51,100,0]),24],[new t([203,0,113,0]),24],[new t([240,0,0,0]),4]],as112:[[new t([192,175,48,0]),24],[new t([192,31,196,0]),24]],amt:[[new t([192,52,193,0]),24]]},t.prototype.kind=function(){return"ipv4"},t.prototype.match=function(t,e){let r;if(void 0===e&&(r=t,t=r[0],e=r[1]),"ipv4"!==t.kind())throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return u(this.octets,t.octets,8,e)},t.prototype.prefixLengthFromSubnetMask=function(){let t=0,e=!1;const r={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let s,n,i;for(s=3;s>=0;s-=1){if(n=this.octets[s],!(n in r))return null;if(i=r[n],e&&0!==i)return null;8!==i&&(e=!0),t+=i}return 32-t},t.prototype.range=function(){return d.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){return this.octets.slice(0)},t.prototype.toIPv4MappedAddress=function(){return d.IPv6.parse(`::ffff:${this.toString()}`)},t.prototype.toNormalizedString=function(){return this.toString()},t.prototype.toString=function(){return this.octets.join(".")},t}(),d.IPv4.broadcastAddressFromCIDR=function(t){try{const e=this.parseCIDR(t),r=e[0].toByteArray(),s=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[];let i=0;for(;i<4;)n.push(parseInt(r[i],10)|255^parseInt(s[i],10)),i++;return new this(n)}catch(t){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},d.IPv4.isIPv4=function(t){return null!==this.parser(t)},d.IPv4.isValid=function(t){try{return new this(this.parser(t)),!0}catch(t){return!1}},d.IPv4.isValidCIDR=function(t){try{return this.parseCIDR(t),!0}catch(t){return!1}},d.IPv4.isValidFourPartDecimal=function(t){return!(!d.IPv4.isValid(t)||!t.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},d.IPv4.isValidCIDRFourPartDecimal=function(t){const e=t.match(/^(.+)\/(\d+)$/);return!(!d.IPv4.isValidCIDR(t)||!e)&&d.IPv4.isValidFourPartDecimal(e[1])},d.IPv4.networkAddressFromCIDR=function(t){let e,r,s,n,i;try{for(e=this.parseCIDR(t),s=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[],r=0;r<4;)n.push(parseInt(s[r],10)&parseInt(i[r],10)),r++;return new this(n)}catch(t){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},d.IPv4.parse=function(t){const e=this.parser(t);if(null===e)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(e)},d.IPv4.parseCIDR=function(t){let e;if(e=t.match(/^(.+)\/(\d+)$/)){const t=parseInt(e[2]);if(t>=0&&t<=32){const r=[this.parse(e[1]),t];return Object.defineProperty(r,"toString",{value:function(){return this.join("/")}}),r}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},d.IPv4.parser=function(t){let e,r,n;if(e=t.match(s.fourOctet))return function(){const t=e.slice(1,6),s=[];for(let e=0;e<t.length;e++)r=t[e],s.push(h(r));return s}();if(e=t.match(s.longValue)){if(n=h(e[1]),n>4294967295||n<0)throw new Error("ipaddr: address outside defined range");return function(){const t=[];let e;for(e=0;e<=24;e+=8)t.push(n>>e&255);return t}().reverse()}return(e=t.match(s.twoOctet))?function(){const t=e.slice(1,4),r=[];if(n=h(t[1]),n>16777215||n<0)throw new Error("ipaddr: address outside defined range");return r.push(h(t[0])),r.push(n>>16&255),r.push(n>>8&255),r.push(255&n),r}():(e=t.match(s.threeOctet))?function(){const t=e.slice(1,5),r=[];if(n=h(t[2]),n>65535||n<0)throw new Error("ipaddr: address outside defined range");return r.push(h(t[0])),r.push(h(t[1])),r.push(n>>8&255),r.push(255&n),r}():null},d.IPv4.subnetMaskFromPrefixLength=function(t){if((t=parseInt(t))<0||t>32)throw new Error("ipaddr: invalid IPv4 prefix length");const e=[0,0,0,0];let r=0;const s=Math.floor(t/8);for(;r<s;)e[r]=255,r++;return s<4&&(e[s]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},d.IPv6=function(){function t(t,e){let r,s;if(16===t.length)for(this.parts=[],r=0;r<=14;r+=2)this.parts.push(t[r]<<8|t[r+1]);else{if(8!==t.length)throw new Error("ipaddr: ipv6 part count should be 8 or 16");this.parts=t}for(r=0;r<this.parts.length;r++)if(s=this.parts[r],!(0<=s&&s<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");e&&(this.zoneId=e)}return t.prototype.SpecialRanges={unspecified:[new t([0,0,0,0,0,0,0,0]),128],linkLocal:[new t([65152,0,0,0,0,0,0,0]),10],multicast:[new t([65280,0,0,0,0,0,0,0]),8],loopback:[new t([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new t([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new t([0,0,0,0,0,65535,0,0]),96],discard:[new t([256,0,0,0,0,0,0,0]),64],rfc6145:[new t([0,0,0,0,65535,0,0,0]),96],rfc6052:[new t([100,65435,0,0,0,0,0,0]),96],"6to4":[new t([8194,0,0,0,0,0,0,0]),16],teredo:[new t([8193,0,0,0,0,0,0,0]),32],benchmarking:[new t([8193,2,0,0,0,0,0,0]),48],amt:[new t([8193,3,0,0,0,0,0,0]),32],as112v6:[[new t([8193,4,274,0,0,0,0,0]),48],[new t([9760,79,32768,0,0,0,0,0]),48]],deprecated:[new t([8193,16,0,0,0,0,0,0]),28],orchid2:[new t([8193,32,0,0,0,0,0,0]),28],droneRemoteIdProtocolEntityTags:[new t([8193,48,0,0,0,0,0,0]),28],reserved:[[new t([8193,0,0,0,0,0,0,0]),23],[new t([8193,3512,0,0,0,0,0,0]),32]]},t.prototype.isIPv4MappedAddress=function(){return"ipv4Mapped"===this.range()},t.prototype.kind=function(){return"ipv6"},t.prototype.match=function(t,e){let r;if(void 0===e&&(r=t,t=r[0],e=r[1]),"ipv6"!==t.kind())throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return u(this.parts,t.parts,16,e)},t.prototype.prefixLengthFromSubnetMask=function(){let t=0,e=!1;const r={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let s,n;for(let i=7;i>=0;i-=1){if(s=this.parts[i],!(s in r))return null;if(n=r[s],e&&0!==n)return null;16!==n&&(e=!0),t+=n}return 128-t},t.prototype.range=function(){return d.subnetMatch(this,this.SpecialRanges)},t.prototype.toByteArray=function(){let t;const e=[],r=this.parts;for(let s=0;s<r.length;s++)t=r[s],e.push(t>>8),e.push(255&t);return e},t.prototype.toFixedLengthString=function(){const t=function(){const t=[];for(let e=0;e<this.parts.length;e++)t.push(p(this.parts[e].toString(16),4));return t}.call(this).join(":");let e="";return this.zoneId&&(e=`%${this.zoneId}`),t+e},t.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const t=this.parts.slice(-2),e=t[0],r=t[1];return new d.IPv4([e>>8,255&e,r>>8,255&r])},t.prototype.toNormalizedString=function(){const t=function(){const t=[];for(let e=0;e<this.parts.length;e++)t.push(this.parts[e].toString(16));return t}.call(this).join(":");let e="";return this.zoneId&&(e=`%${this.zoneId}`),t+e},t.prototype.toRFC5952String=function(){const t=/((^|:)(0(:|$)){2,})/g,e=this.toNormalizedString();let r,s=0,n=-1;for(;r=t.exec(e);)r[0].length>n&&(s=r.index,n=r[0].length);return n<0?e:`${e.substring(0,s)}::${e.substring(s+n)}`},t.prototype.toString=function(){return this.toRFC5952String()},t}(),d.IPv6.broadcastAddressFromCIDR=function(t){try{const e=this.parseCIDR(t),r=e[0].toByteArray(),s=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[];let i=0;for(;i<16;)n.push(parseInt(r[i],10)|255^parseInt(s[i],10)),i++;return new this(n)}catch(t){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${t})`)}},d.IPv6.isIPv6=function(t){return null!==this.parser(t)},d.IPv6.isValid=function(t){if("string"==typeof t&&-1===t.indexOf(":"))return!1;try{const e=this.parser(t);return new this(e.parts,e.zoneId),!0}catch(t){return!1}},d.IPv6.isValidCIDR=function(t){if("string"==typeof t&&-1===t.indexOf(":"))return!1;try{return this.parseCIDR(t),!0}catch(t){return!1}},d.IPv6.networkAddressFromCIDR=function(t){let e,r,s,n,i;try{for(e=this.parseCIDR(t),s=e[0].toByteArray(),i=this.subnetMaskFromPrefixLength(e[1]).toByteArray(),n=[],r=0;r<16;)n.push(parseInt(s[r],10)&parseInt(i[r],10)),r++;return new this(n)}catch(t){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${t})`)}},d.IPv6.parse=function(t){const e=this.parser(t);if(null===e.parts)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(e.parts,e.zoneId)},d.IPv6.parseCIDR=function(t){let e,r,s;if((r=t.match(/^(.+)\/(\d+)$/))&&(e=parseInt(r[2]),e>=0&&e<=128))return s=[this.parse(r[1]),e],Object.defineProperty(s,"toString",{value:function(){return this.join("/")}}),s;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},d.IPv6.parser=function(t){let e,r,s,n,i,o;if(s=t.match(c.deprecatedTransitional))return this.parser(`::ffff:${s[1]}`);if(c.native.test(t))return l(t,8);if((s=t.match(c.transitional))&&(o=s[6]||"",e=s[1],s[1].endsWith("::")||(e=e.slice(0,-1)),e=l(e+o,6),e.parts)){for(i=[parseInt(s[2]),parseInt(s[3]),parseInt(s[4]),parseInt(s[5])],r=0;r<i.length;r++)if(n=i[r],!(0<=n&&n<=255))return null;return e.parts.push(i[0]<<8|i[1]),e.parts.push(i[2]<<8|i[3]),{parts:e.parts,zoneId:e.zoneId}}return null},d.IPv6.subnetMaskFromPrefixLength=function(t){if((t=parseInt(t))<0||t>128)throw new Error("ipaddr: invalid IPv6 prefix length");const e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let r=0;const s=Math.floor(t/8);for(;r<s;)e[r]=255,r++;return s<16&&(e[s]=Math.pow(2,t%8)-1<<8-t%8),new this(e)},d.fromByteArray=function(t){const e=t.length;if(4===e)return new d.IPv4(t);if(16===e)return new d.IPv6(t);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},d.isValid=function(t){return d.IPv6.isValid(t)||d.IPv4.isValid(t)},d.isValidCIDR=function(t){return d.IPv6.isValidCIDR(t)||d.IPv4.isValidCIDR(t)},d.parse=function(t){if(d.IPv6.isValid(t))return d.IPv6.parse(t);if(d.IPv4.isValid(t))return d.IPv4.parse(t);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},d.parseCIDR=function(t){try{return d.IPv6.parseCIDR(t)}catch(e){try{return d.IPv4.parseCIDR(t)}catch(t){throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},d.process=function(t){const e=this.parse(t);return"ipv6"===e.kind()&&e.isIPv4MappedAddress()?e.toIPv4Address():e},d.subnetMatch=function(t,e,r){let s,n,i,o;for(n in null==r&&(r="unicast"),e)if(Object.prototype.hasOwnProperty.call(e,n))for(i=e[n],!i[0]||i[0]instanceof Array||(i=[i]),s=0;s<i.length;s++)if(o=i[s],t.kind()===o[0].kind()&&t.match.apply(t,o))return n;return r},t.exports?t.exports=d:e.ipaddr=d}(this)}},e={};function r(s){var n=e[s];if(void 0!==n)return n.exports;var i=e[s]={exports:{}};return t[s].call(i.exports,i,i.exports,r),i.exports}r.d=(t,e)=>{for(var s in e)r.o(e,s)&&!r.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};(()=>{"use strict";r.r(s),r.d(s,{extensions:()=>n,logging:()=>t,packet:()=>e,server:()=>i});var t={};r.r(t),r.d(t,{DEBUG:()=>o,ERROR:()=>l,INFO:()=>a,NONE:()=>u,WARN:()=>c,debug:()=>f,error:()=>m,get_timestamp:()=>p,info:()=>w,log:()=>_,log_level:()=>h,set_level:()=>d,warn:()=>v});var e={};r.r(e),r.d(e,{ClosePayload:()=>C,ConnectPayload:()=>x,ContinuePayload:()=>E,DataPayload:()=>z,InfoPayload:()=>S,WispBuffer:()=>P,WispPacket:()=>$,close_reasons:()=>U,packet_classes:()=>D,packet_types:()=>R,stream_types:()=>A});var n={};r.r(n),r.d(n,{BaseExtension:()=>ht,MOTDExtension:()=>ft,PasswordAuthExtension:()=>dt,UDPExtension:()=>pt,extensions_map:()=>vt,parse_extensions:()=>wt,serialize_extensions:()=>_t});var i={};r.r(i),r.d(i,{ServerConnection:()=>kt,ServerStream:()=>yt,options:()=>T,parse_real_ip:()=>$t,routeRequest:()=>xt});const o=0,a=1,c=2,l=3,u=4;let h=a;function p(){let[t,e]=(new Date).toJSON().split("T");return t=t.replaceAll("-","/"),e=e.split(".")[0],`[${t} - ${e}]`}function d(t){h=t}function f(){if(!(h>o)){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.debug(p()+" debug:",...e)}}function w(){if(!(h>a)){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.info(p()+" info:",...e)}}function _(){if(!(h>a)){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.log(p()+" log:",...e)}}function v(){if(!(h>c)){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.warn(p()+" warn:",...e)}}function m(){if(!(h>l)){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.error(p()+" error:",...e)}}function y(t,e,r){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}const g=new TextEncoder,b=g.encode.bind(g),k=new TextDecoder,I=k.decode.bind(k);class P{constructor(t){if(t instanceof Uint8Array)this.from_array(t);else if("number"==typeof t)this.from_array(new Uint8Array(t));else{if("string"!=typeof t)throw console.trace(),"invalid data type passed to wisp buffer constructor";this.from_array(b(t))}}from_array(t){this.size=t.length,this.bytes=t,this.view=new DataView(t.buffer)}concat(t){let e=new P(this.size+t.size);return e.bytes.set(this.bytes,0),e.bytes.set(t.bytes,this.size),e}slice(t,e){let r=this.bytes.slice(t,e);return new P(r)}get_string(){return k.decode(this.bytes)}}class ${constructor(t){let{type:e,stream_id:r,payload:s,payload_bytes:n}=t;this.type=e,this.stream_id=r,this.payload_bytes=n,this.payload=s}static parse(t){return new $({type:t.view.getUint8(0),stream_id:t.view.getUint32(1,!0),payload_bytes:t.slice(5)})}static parse_all(t){if(t.size<$.min_size)throw TypeError("packet too small");let e=$.parse(t),r=D[e.type];if(void 0===r)throw TypeError("invalid packet type");if(e.payload_bytes.size<r.size)throw TypeError("payload too small");return e.payload=r.parse(e.payload_bytes),e}serialize(){let t=new P(5);return t.view.setUint8(0,this.type),t.view.setUint32(1,this.stream_id,!0),t=t.concat(this.payload.serialize()),t}}y($,"min_size",5);class x{constructor(t){let{stream_type:e,port:r,hostname:s}=t;this.stream_type=e,this.port=r,this.hostname=s}static parse(t){return new x({stream_type:t.view.getUint8(0),port:t.view.getUint16(1,!0),hostname:I(t.slice(3).bytes)})}serialize(){let t=new P(3);return t.view.setUint8(0,this.stream_type),t.view.setUint16(1,this.port,!0),t=t.concat(new P(this.hostname)),t}}y(x,"min_size",3),y(x,"type",1),y(x,"name","CONNECT");class z{constructor(t){let{data:e}=t;this.data=e}static parse(t){return new z({data:t})}serialize(){return this.data}}y(z,"min_size",0),y(z,"type",2),y(z,"name","DATA");class E{constructor(t){let{buffer_remaining:e}=t;this.buffer_remaining=e}static parse(t){return new E({buffer_remaining:t.view.getUint32(0,!0)})}serialize(){let t=new P(4);return t.view.setUint32(0,this.buffer_remaining,!0),t}}y(E,"type",3),y(E,"name","CONTINUE");class C{constructor(t){let{reason:e}=t;this.reason=e}static parse(t){return new C({reason:t.view.getUint8(0)})}serialize(){let t=new P(1);return t.view.setUint8(0,this.reason),t}}y(C,"min_size",1),y(C,"type",4),y(C,"name","CLOSE");class S{constructor(t){let{major_ver:e,minor_ver:r,extensions:s}=t;this.major_ver=e,this.minor_ver=r,this.extensions=s}static parse(t){return new S({major_ver:t.view.getUint8(0),minor_ver:t.view.getUint8(1),extensions:t.slice(2)})}serialize(){let t=new P(2);return t.view.setUint8(0,this.major_ver),t.view.setUint8(1,this.minor_ver),t.concat(this.extensions)}}y(S,"min_size",2),y(S,"type",5),y(S,"name","INFO");const D={1:x,2:z,3:E,4:C,5:S},R={CONNECT:1,DATA:2,CONTINUE:3,CLOSE:4,INFO:5},A={TCP:1,UDP:2},U={Unknown:1,Voluntary:2,NetworkError:3,IncompatibleExtensions:4,InvalidInfo:65,UnreachableHost:66,NoResponse:67,ConnRefused:68,TransferTimeout:71,HostBlocked:72,ConnThrottled:73,ClientError:129,AuthBadPassword:192,AuthBadSignature:193,AuthMissingCredentials:194},T={hostname_blacklist:null,hostname_whitelist:null,port_blacklist:null,port_whitelist:null,allow_direct_ip:!0,allow_private_ips:!1,allow_loopback_ips:!1,client_ip_blacklist:null,client_ip_whitelist:null,stream_limit_per_host:-1,stream_limit_total:-1,allow_udp_streams:!0,allow_tcp_streams:!0,dns_ttl:120,dns_method:"lookup",dns_servers:null,dns_result_order:"verbatim",parse_real_ip:!0,parse_real_ip_from:["127.0.0.1"],wisp_version:2,wisp_motd:null},O="undefined"==typeof globalThis?window:globalThis,j=O.WebSocket,N=O.crypto,M=null,q=null;class B{constructor(t){(function(t,e,r){(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r})(this,"send_buffer_size",33554432),this.ws=t,this.connected=!1,this.data_queue=new V(1)}async connect(){await new Promise((t,e)=>{this.ws.onopen=()=>{this.connected=!0,t()},this.ws.onmessage=t=>{this.data_queue.put(t.data)},this.ws.onclose=()=>{this.connected?this.data_queue.close():e()},this.ws.readyState===this.ws.OPEN&&(this.connected=!0,t())})}async recv(){return await this.data_queue.get()}async send(t){if(t instanceof $&&(t=t.serialize().bytes),this.ws.send(t),!(this.ws.bufferedAmount<=this.send_buffer_size))for(;!(this.ws.bufferedAmount<=this.send_buffer_size/2);)await new Promise(t=>{setTimeout(t,10)})}close(t,e){this.ws.close(t,e),this.data_queue.close()}get buffered_amount(){return this.ws.bufferedAmount}}class V{constructor(t){this.max_size=t,this.queue=[],this.put_callbacks=[],this.get_callbacks=[]}put_now(t){var e;this.queue.push(t),null===(e=this.get_callbacks.shift())||void 0===e||e()}async put(t){this.size<=this.max_size||await new Promise(t=>{this.put_callbacks.push(t)}),this.put_now(t)}get_now(){var t;return null===(t=this.put_callbacks.shift())||void 0===t||t(),this.queue.shift()}async get(){return this.size>0||await new Promise(t=>{this.get_callbacks.push(t)}),this.get_now()}close(){let t;for(this.queue=[];t=this.get_callbacks.shift();)t();for(;t=this.put_callbacks.shift();)t()}get size(){return this.queue.length}}const F="undefined"!=typeof process,L=new Map;let H=null,W=null;function G(){if(!F)throw new Error("not running on node.js")}function J(t){return W.resolve4(t)}function K(t){return W.resolve6(t)}async function Q(t,e,r){try{return(await t(r))[0]}catch(t){return(await e(r))[0]}}async function X(t){if(!F)return t;let e=M.isIP(t);if(4===e||6===e)return t;let r=Date.now();for(let[t,e]of L)r-e.time>T.dns_ttl&&L.delete(t);let s,n=L.get(t);if(n){if(n.error)throw n.error;return n.address}try{s=await async function(t){if("lookup"===T.dns_method)return(await null.lookup(t,{order:T.dns_result_order})).address;if("resolve"===T.dns_method){if(W||(W=new null.Resolver),T.dns_servers!==H&&(f("Setting custom DNS servers to: "+T.dns_servers.join(", ")),W.setServers(T.dns_servers),H=T.dns_servers),"verbatim"===T.dns_result_order||"ipv6first"===T.dns_result_order)return await Q(K,J,t);if("ipv4first"===T.dns_result_order)return await Q(J,K,t);throw new Error("Invalid result order. options.dns_result_order must be either 'ipv6first', 'ipv4first', or 'verbatim'.")}if("function"==typeof T.dns_method)return await T.dns_method(t);throw new Error("Invalid DNS method. options.dns_method must either be 'lookup' or 'resolve'.")}(t),f(`Domain resolved: ${t} -> ${s}`),L.set(t,{time:Date.now(),address:s})}catch(e){throw L.set(t,{time:Date.now(),error:e}),e}return s}class Y{constructor(t,e){G(),this.hostname=t,this.port=e,this.recv_buffer_size=128,this.socket=null,this.paused=!1,this.connected=!1,this.data_queue=new V(this.recv_buffer_size)}async connect(){let t=await X(this.hostname);await new Promise((e,r)=>{this.socket=new M.Socket,this.socket.setNoDelay(!0),this.socket.on("connect",()=>{this.connected=!0,e()}),this.socket.on("data",t=>{this.data_queue.put(t)}),this.socket.on("close",t=>{t&&!this.connected?r():this.data_queue.close(),this.socket=null}),this.socket.on("error",t=>{v(`tcp stream to ${this.hostname} ended with error - ${t}`)}),this.socket.on("end",()=>{this.socket&&(this.socket.destroy(),this.socket=null)}),this.socket.connect({host:t,port:this.port})})}async recv(){return await this.data_queue.get()}async send(t){await new Promise(e=>{this.socket.write(t,e)})}async close(){this.socket&&(this.socket.end(),this.socket=null)}pause(){this.data_queue.size>=this.data_queue.max_size&&(this.socket.pause(),this.paused=!0)}resume(){this.socket&&this.paused&&(this.socket.resume(),this.paused=!1)}}class Z{constructor(t,e){G(),this.hostname=t,this.port=e,this.connected=!1,this.recv_buffer_size=128,this.data_queue=new V(this.recv_buffer_size)}async connect(){let t=await X(this.hostname),e=M.isIP(t);await new Promise((r,s)=>{this.socket=null.createSocket(6===e?"udp6":"udp4"),this.socket.on("connect",()=>{r()}),this.socket.on("message",t=>{this.data_queue.put(t)}),this.socket.on("error",()=>{this.connected||s(),this.data_queue.close(),this.socket=null}),this.socket.connect(this.port,t)})}async recv(){return await this.data_queue.get()}async send(t){this.socket.send(t)}async close(){this.socket&&(this.socket.close(),this.socket=null)}pause(){}resume(){}}var tt,et,rt=r(706);class st extends Error{}function nt(t,e){return t===e||t[0]<=e&&t[1]>=e}function it(t,e){let r=!1;for(let s of t)if(e(s)){r=!0;break}return!r}function ot(t,e){for(let r of t)if(e(r))return!0;return!1}function at(t,e){return e.includes(t.range())}async function ct(t,e,r,s){if(!T.allow_tcp_streams&&e===A.TCP)return U.HostBlocked;if(!T.allow_udp_streams&&e===A.UDP)return U.HostBlocked;if(T.hostname_whitelist){if(it(T.hostname_whitelist,t=>t.test(r)))return U.HostBlocked}else if(T.hostname_blacklist&&ot(T.hostname_blacklist,t=>t.test(r)))return U.HostBlocked;if(T.port_whitelist){if(it(T.port_whitelist,t=>nt(t,s)))return U.HostBlocked}else if(T.port_blacklist&&ot(T.port_blacklist,t=>nt(t,s)))return U.HostBlocked;let n=r;if(rt.isValid(r)){if(!T.allow_direct_ip)return U.HostBlocked}else try{n=await X(r)}catch(t){}if(function(t){if(!rt.isValid(t))return!1;let e=rt.parse(t);return!(T.allow_loopback_ips||!at(e,["loopback","unspecified"]))||!(T.allow_private_ips||!at(e,["broadcast","linkLocal","carrierGradeNat","private","reserved"]))}(n))return U.HostBlocked;if(!t)return 0;if(-1!==T.stream_limit_total&&Object.keys(t.streams).length>=T.stream_limit_total)return U.ConnThrottled;if(-1!==T.stream_limit_per_host){let e=0;for(let s of t.streams)s.socket.hostname===r&&e++;if(e>=T.stream_limit_per_host)return U.ConnThrottled}return 0}function lt(t,e,r){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class ut{constructor(){}static parse(){return new ut}serialize(){return new P(0)}}class ht{constructor(){let{server_config:t,client_config:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.id=this.constructor.id,this.name=this.constructor.name,t?this.payload=new this.constructor.Server(t):e&&(this.payload=new this.constructor.Client(e))}static parse(t,e,r){let s=new t({});if("client"===r)s.payload=t.Client.parse(e.slice(5));else{if("server"!==r)throw TypeError("invalid role");s.payload=t.Server.parse(e.slice(5))}return s}serialize(){let t=new P(5),e=this.payload.serialize();return t.view.setInt8(0,this.constructor.id),t.view.setUint32(1,e.size,!0),t.concat(e)}}lt(ht,"id",0),lt(ht,"name",""),lt(ht,"Server",ut),lt(ht,"Client",ut);class pt extends ht{}lt(pt,"id",1),lt(pt,"name","UDP");class dt extends ht{}tt=dt,lt(dt,"id",2),lt(dt,"name","Password Authentication"),lt(dt,"Server",class{constructor(t){let{required:e=1}=t;this.required=e?1:0}static parse(t){return new tt.Server({required:t.view.getUint8(0)})}serialize(){let t=new P(1);return t.view.setUint8(0,this.required),t}}),lt(dt,"Client",class{constructor(t){let{username:e,password:r}=t;this.username=e,this.password=r}static parse(t){let e=t.view.getUint8(0),r=t.view.getUint16(1,!0),s=e+3;return new tt.Client({username:t.slice(3,e).get_string(),password:t.slice(s,r).get_string()})}serialize(){let t=new P(this.username),e=new P(this.password),r=new P(3);return r.view.setUint8(0,t.size),r.view.setUint16(1,e.size,!0),r.concat(t).concat(e)}});class ft extends ht{}function wt(t,e,r){let s=[];for(;t.size;){let n,i=t.view.getUint8(0),o=t.view.getUint32(1,!0),a=t.slice(0,5+o);for(let t of e)if(t.id===i){n=t.constructor;break}if(n){let t=ht.parse(n,a,r);s.push(t)}t=t.slice(5+o)}return s}function _t(t){{let e=new P(0);for(let r of t)e=e.concat(r.serialize());return e}}et=ft,lt(ft,"id",4),lt(ft,"name","Server MOTD"),lt(ft,"Server",class{constructor(t){let{message:e}=t;this.message=e}static parse(t){return new et.Server({message:t.get_string()})}serialize(){return new P(this.message)}}),lt(ft,"Client",ut);const vt={1:pt,2:dt,4:ft};class mt extends Error{}class yt{constructor(t,e,r){this.stream_id=t,this.conn=e,this.socket=r,this.send_buffer=new V(yt.buffer_size),this.packets_sent=0}async setup(){await this.socket.connect(),this.tcp_to_ws().catch(t=>{m(`(${this.conn.conn_id}) a tcp/udp to ws task encountered an error - ${t}`),this.close()}),this.ws_to_tcp().catch(t=>{m(`(${this.conn.conn_id}) a ws to tcp/udp task encountered an error - ${t}`),this.close()})}async tcp_to_ws(){for(;;){let t=await this.socket.recv();if(null==t)break;this.socket.pause();let e=new $({type:z.type,stream_id:this.stream_id,payload:new z({data:new P(new Uint8Array(t))})});await this.conn.ws.send(e),this.socket.resume()}await this.conn.close_stream(this.stream_id,U.Voluntary)}async ws_to_tcp(){for(;;){let t=await this.send_buffer.get();if(null==t)break;if(await this.socket.send(t),this.packets_sent++,this.packets_sent%(yt.buffer_size/2)!=0)continue;let e=new $({type:E.type,stream_id:this.stream_id,payload:new E({buffer_remaining:yt.buffer_size-this.send_buffer.size})});this.conn.ws.send(e)}await this.close()}async close(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.send_buffer.close(),this.socket.close(),null==t)return;let e=new $({type:C.type,stream_id:this.stream_id,payload:new C({reason:t})});await this.conn.ws.send(e)}async put_data(t){await this.send_buffer.put(t)}}var gt,bt;gt=yt,(bt=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(bt="buffer_size"))in gt?Object.defineProperty(gt,bt,{value:128,enumerable:!0,configurable:!0,writable:!0}):gt[bt]=128;class kt{constructor(t,e){let{TCPSocket:r,UDPSocket:s,ping_interval:n,wisp_version:i,wisp_extensions:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.ws=new B(t),this.path=e,this.TCPSocket=r||Y,this.UDPSocket=s||Z,this.ping_interval=n||30,this.wisp_version=i||T.wisp_version,this.wisp_extensions=o||null,this.ping_task=null,this.streams={},this.conn_id=N.randomUUID().split("-")[0],this.server_exts={},this.client_exts={},2===this.wisp_version&&null===this.wisp_extensions&&this.add_extensions()}add_extensions(){this.wisp_extensions=[],T.allow_udp_streams&&this.wisp_extensions.push(new pt({server_config:{}})),T.wisp_motd&&this.wisp_extensions.push(new ft({server_config:{message:T.wisp_motd}}))}async setup(){w(`setting up new wisp v${this.wisp_version} connection with id ${this.conn_id}`),await this.ws.connect(),2==this.wisp_version&&await this.setup_wisp_v2();let t=new $({type:E.type,stream_id:0,payload:new E({buffer_remaining:yt.buffer_size})});this.ws.send(t),"function"==typeof this.ws.ws.ping&&(this.ping_task=setInterval(()=>{f(`(${this.conn_id}) sending websocket ping`),this.ws.ws.ping()},1e3*this.ping_interval))}async setup_wisp_v2(){let t=_t(this.wisp_extensions),e=new $({type:S.type,stream_id:0,payload:new S({major_ver:this.wisp_version,minor_ver:0,extensions:t})});this.ws.send(e);let r=await this.ws.recv();if(null==r)throw v(`(${this.conn_id}) handshake error: ws closed before handshake complete`),await this.cleanup(),new mt;let s=new P(new Uint8Array(r)),n=$.parse_all(s);if(n.type!==S.type)throw v(`(${this.conn_id}) handshake error: unexpected packet of type ${n.type}`),await this.cleanup(),new mt;let i=wt(n.payload.extensions,this.wisp_extensions,"client");for(let t of i)for(let e of this.wisp_extensions)e.id===t.id&&(this.server_exts[e.id]=e,this.client_exts[t.id]=t)}create_stream(t,e,r,s){let n=new(e===A.TCP?this.TCPSocket:this.UDPSocket)(r,s),i=new yt(t,this,n);this.streams[t]=i,(async()=>{let n=await ct(this,e,r,s);if(n)return v(`(${this.conn_id}) refusing to create a stream to ${r}:${s}`),void await this.close_stream(t,n,!0);try{await i.setup()}catch(e){v(`(${this.conn_id}) creating a stream to ${r}:${s} failed - ${e}`),await this.close_stream(t,U.NetworkError)}})()}async close_stream(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=this.streams[t];null!=s&&(e&&!r&&w(`(${this.conn_id}) closing stream to ${s.socket.hostname} for reason ${e}`),await s.close(e),delete this.streams[t])}route_packet(t){let e=$.parse_all(t),r=this.streams[e.stream_id];if(null!=r||e.type!=z.type)if(e.type===x.type){let t=e.payload.stream_type===A.TCP?"TCP":"UDP";w(`(${this.conn_id}) opening new ${t} stream to ${e.payload.hostname}:${e.payload.port}`),this.create_stream(e.stream_id,e.payload.stream_type,e.payload.hostname.trim(),e.payload.port)}else e.type===z.type?r.put_data(e.payload.data.bytes):e.type==E.type?v(`(${this.conn_id}) client sent a CONTINUE packet, this should never be possible`):e.type==C.type&&this.close_stream(e.stream_id,e.reason);else v(`(${this.conn_id}) received a DATA packet for a stream which doesn't exist`)}async run(){for(;;){let t;if(t=await this.ws.recv(),null==t)break;if("string"!=typeof t)try{this.route_packet(new P(new Uint8Array(t)))}catch(t){v(`(${this.conn_id}) routing a packet failed - ${t}`)}else v(`(${this.conn_id}) routing a packet failed - unexpected ws text frame`)}await this.cleanup()}async cleanup(){for(let t of Object.keys(this.streams))await this.close_stream(t);clearInterval(this.ping_task),w(`(${this.conn_id}) wisp connection closed`),this.ws.close()}}class It{constructor(t,e){let[r,s]=e.split("/").pop().split(":");this.hostname=r.trim(),this.port=parseInt(s),this.ws=new B(t)}async setup(){if(await this.ws.connect(),0!==await ct(null,A.TCP,this.hostname,this.port))throw w(`Refusing to create a wsproxy connection to ${this.hostname}:${this.port}`),this.ws.close(),new st;this.socket=new Y(this.hostname,this.port),await this.socket.connect(),this.tcp_to_ws().catch(t=>{m(`a tcp to ws task (wsproxy) encountered an error - ${t}`)}),this.ws_to_tcp().catch(t=>{m(`a ws to tcp task (wsproxy) encountered an error - ${t}`)})}async tcp_to_ws(){for(;;){let t=await this.socket.recv();if(null==t)break;this.socket.pause(),await this.ws.send(t),this.socket.resume()}await this.ws.close()}async ws_to_tcp(){for(;;){let t;if(t=await this.ws.recv(),null==t)break;await this.socket.send(t)}await this.socket.close()}}let Pt=null;function $t(t,e){if(T.parse_real_ip&&T.parse_real_ip_from.includes(e)){if(t["x-forwarded-for"])return t["x-forwarded-for"].split(",")[0].trim();if(t["x-real-ip"])return t["x-real-ip"]}return e}function xt(t,e,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};G(),t.headers["sec-websocket-protocol"]&&2===T.wisp_version?s.wisp_version=2:s.wisp_version=1,t instanceof q.IncomingMessage?Pt.handleUpgrade(t,e,r,e=>{zt(e,t.url,t,s)}):t instanceof j&&zt(ws,"/",{})}async function zt(t,e,r,s){t.binaryType="arraybuffer";let n=r.socket.address().address;w(`new connection on ${e} from ${$t(r.headers,n)} (origin: ${r.headers.origin})`);try{if(e.endsWith("/")){let r=new kt(t,e,s);await r.setup(),await r.run()}else{let r=new It(t,e,s);await r.setup()}}catch(e){if(t.close(),e instanceof mt)return;if(e instanceof st)return;m("Uncaught server error:\n"+(e.stack||e))}}F&&(Pt=new null({noServer:!0}))})(),wisp_server=s})();
//# sourceMappingURL=wisp-server-legacy.js.map